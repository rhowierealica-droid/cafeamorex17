// /.netlify/functions/create-checkout.js

require("dotenv").config();
const axios = require("axios");
const PAYMONGO_SECRET_KEY = process.env.PAYMONGO_SECRET_KEY;
const PAYMONGO_API = "https://api.paymongo.com/v1";

exports.handler = async (event, context) => {
    if (event.httpMethod !== "POST") {
        return { statusCode: 405, body: "Method Not Allowed" };
    }

    if (!PAYMONGO_SECRET_KEY) {
        return { statusCode: 500, body: JSON.stringify({ error: "PAYMONGO_SECRET_KEY not set" }) };
    }

    let requestBody;
    try {
        requestBody = JSON.parse(event.body);
    } catch (e) {
        return { statusCode: 400, body: JSON.stringify({ error: "Invalid JSON body" }) };
    }

    const { amount, description, metadata } = requestBody;

    // We no longer require orderItems in the body, only the IDs and user info
    if (!amount || amount < 100 || !metadata?.userId || !metadata?.queueNumber || !metadata?.cartItemIds || metadata.cartItemIds.length === 0) {
        return { statusCode: 400, body: JSON.stringify({ error: "Invalid order details or missing critical IDs" }) };
    }

    // ⭐ ASSUMPTION: The incoming requestBody now includes a 'lineItems' array 
    // generated by the client-side app for PayMongo's required format.
    // If not, you must modify your client to calculate the lineItems array 
    // and include it in the request body, or include 'orderItems' here to rebuild it.
    
    // TEMPORARY FIX: Rebuilding lineItems from orderItems, assuming the client still sends it for THIS purpose.
    const clientOrderItems = metadata.orderItems;

    if (!clientOrderItems || clientOrderItems.length === 0) {
        return { statusCode: 400, body: JSON.stringify({ error: "Missing 'orderItems' array in the request body for PayMongo line_items generation." }) };
    }

    // --- Build PayMongo Line Items ---
    const lineItems = clientOrderItems.flatMap(item => {
        const qty = Number(item.qty || 1);
        // Base and size price combined
        const baseAmount = Math.round(
            (Number(item.basePrice || 0) + Number(item.sizePrice || 0)) * 100
        );

        const itemsArray = [
            {
                name: item.product || "Unnamed Product",
                currency: "PHP",
                amount: baseAmount,
                quantity: qty,
            },
        ];

        // Add-ons
        (item.addons || []).forEach(addon => {
            itemsArray.push({
                name: `${item.product || "Product"} Add-on: ${addon.name || "Addon"}`,
                currency: "PHP",
                amount: Math.round(Number(addon.price || 0) * 100),
                quantity: qty,
            });
        });

        return itemsArray;
    });

    // Delivery Fee
    const deliveryFee = Number(metadata.deliveryFee || 0);
    if (deliveryFee > 0) {
        lineItems.push({
            name: "Delivery Fee",
            currency: "PHP",
            amount: Math.round(deliveryFee * 100),
            quantity: 1,
        });
    }
    // --- End Build PayMongo Line Items ---

    try {
        const response = await axios.post(
            `${PAYMONGO_API}/checkout_sessions`,
            {
                data: {
                    attributes: {
                        success_url: process.env.SUCCESS_URL || 'https://your-public-domain.com/index.html', 
                        cancel_url: process.env.CANCEL_URL || 'https://your-public-domain.com/cart.html',
                        send_email_receipt: false,
                        description: description || `Payment for Order #${metadata.queueNumber}`,
                        line_items: lineItems,
                        payment_method_types: ["gcash"],
                        metadata: {
                            ...metadata,
                            // ⭐ CRITICAL CLEANUP: Stop sending complex orderItems in metadata
                            // The webhook will now fetch items from the cart directly using cartItemIds
                            orderItems: undefined, // Explicitly remove
                            cartItemIds: metadata.cartItemIds,
                        },
                    },
                },
            },
            {
                headers: {
                    Authorization: `Basic ${Buffer.from(PAYMONGO_SECRET_KEY + ":").toString("base64")}`,
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
            }
        );

        return {
            statusCode: 200,
            body: JSON.stringify({ checkout_url: response.data.data.attributes.checkout_url }),
        };
    } catch (error) {
        console.error(
            "❌ PayMongo Checkout Error:",
            error.response?.data || error.message
        );
        return {
            statusCode: 500,
            body: JSON.stringify({
                error: "Failed to create checkout session",
                details: error.response?.data || error.message,
            }),
        };
    }
};
